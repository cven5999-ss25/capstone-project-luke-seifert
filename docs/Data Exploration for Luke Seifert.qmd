---
title: "First doc creation - data analysis"
author:
  - name: "Luke Seifert"
    orcid: "0009-0007-4689-8492"
    email: "luse8755@colorado.edu"
    affiliation:
      - name: "University of Colorado Boulder"
        department: "Department of Civil, Environmental and Architectural Engineering"
        city: "Boulder"
        state: "CO"
        country: "USA"
date: today
format: html
editor: visual
---

# Introduction

I am in Blantyre, Malawi, working with Water For People (WFP) - Malawi to collect data on their rural piped water schemes. WFP has built many piped water schemes for rural communities, either from scratch or by upgrading an existing handpump borehole. Once the scheme is handed over to the community, the community is responsible for keeping the system running, encouraging ownership and sustainability, yet some schemes have been struggling to finance their own repairs.

I have been surveying these rural water scheme commities, collecting data on the costs they incur for keeping their water systems running and the monthly revenue they collect via tariffs. By comparing the costs and revenue generated by the schemes, we aim to try and identify the best practices in the rural water sector. The goal is to determine the gaps between costs and revenue, identify any trends between revenue collection and scheme success, and provide stakeholders with the results to encourage data-based decision making. Identifying these trends will help law makers and scheme committies to implement best practices to encourage sustainability of these rural schemes.

My data set will have quantitative data regarding costs of CapEx, CapManEx, and OpEx, quantitative data regarding revenue generated, qualitative data regarding tariff collection methods, and qualitative data regarding scheme sustainability and productivity.

# Methods

## Reading the Data

```{r}

# Load packages
library(tidyverse)
library(dplyr)
library(readr)
library(ggplot2)

# Read data
raw_data <- read_csv(here::here("data/raw/WFP_data_cleaned_with_joseph_7_10.csv"))
```

## Data Exploration Approach

The survey used for data collection was designed by myself in partnership with WFP. Due to resource allocation and a language barrier between myself and the rural communities, we relied on local workers employed by the government to collect the majority of this data. These workers are called "Water Monitoring Assistants", or "WMAs", and they oversee water access infrastructure in these rural areas.

We hosted a training session with the WMAs to show them how to properly deliver this survey to the water scheme committees. Fuel was then provided for the WMAs and they were sent out to their respective areas.

Being several degrees removed from the data we are collecting, the survey responses needed some cleaning up before being able to be analyzed.

## Initial Data Tidying

Before the data set was able to be uploaded into posit.cloud, initial data tidying consisted heavily of fixing obvious data entry errors, addressing inconsistencies or questions left blank, and creating useful data out of response discrepancies.

Some questions were often skipped over and answered partially. Some data recieved was contradictory and needed clarification. Other data was difficult to decipher due to our language barrier. Surveys with these issues were rejected and sent back to the corresponding WMA for re-submission.

The resulting tidied data set has been uploaded to the data/raw folder, and is ready for further data tidying and analysis.

# Results

## Initial Data Exploration

```{r}

#adding data to view first few rows of raw data

#head(raw_data)
dim(raw_data)
#spec(raw_data)
#colnames(raw_data)
```

```{r}
# Select only the desired columns
filtered_data <- raw_data |> 
  select(
    # General Info
    "What is your full name?",
    "District",
    "What is the name of the scheme you are currently visiting?",

    # Misc
    "How many total households does this scheme service? (HH)",
    "When was the scheme finished being built?...3",
    "How much total water can they hold? (liters)",
    "What is the average household monthly income in this village? (kwacha)",

    # CapManEx
    "ADDED: Total CapManEx costs (Kwacha)",

    # OpEx
    "ADDED: Are guards stationed at the scheme by the scheme committee?",
    "ADDED: If yes, how much are they paid in total? (kwacha)",
    "ADDED: Do they consistently use chlorine?",
    "ADDED: average monthly minor repair costs",
    "ADDED: Is the tank ever cleaned?",
    "ADDED: What additional monthly costs does the cleaning incur?",

    # Tariff Revenue
    "What percent of users regularly pay the tariffs? (%)",
    "ADDED: What percent can pay but don't want to?",
    "ADDED: What percent can't pay?",
    "How are tariffs collected?",
    "How many communal taps are there?",
    "ADDED: Communal tap monthly rate",
    "How many private household taps are there?",
    "ADDED: What is the monthly private household connection rate? (monthly kwacha)",
    "How many Public Institution taps are there? Ex) school or healthcare facility",
    "ADDED: Public Institution monthly contribution",
    "How much is currently in your bank account? (kwacha)",
    "How much do you have in cash? (kwacha)",

    # Concluding Questions
    "ADDED: Is the scheme able to finance its own repairs?",
    "ADDED: Do the tanks ever go empty?",
    "ADDED: Did the scheme committee mention the need for better community engagement or more trainings?"
  )

# Delete empty rows
filtered_data <- filtered_data[-c(25:35), ]

# View the filtered data
view(filtered_data)
colnames(filtered_data)

```

```{r}

collumns <- colnames(filtered_data)

# Rename columns for easier coding
filtered_data_renamed <- filtered_data |> 
  rename(name = "What is the name of the scheme you are currently visiting?",
         HH = "How many total households does this scheme service? (HH)",
         HH_monthly_income = "What is the average household monthly income in this village? (kwacha)",
         date_finished = "When was the scheme finished being built?...3", 
         water_volume = "How much total water can they hold? (liters)",
         CapManEx_cost = "ADDED: Total CapManEx costs (Kwacha)",
         guard = "ADDED: Are guards stationed at the scheme by the scheme committee?", 
         guard_mo_cost = "ADDED: If yes, how much are they paid in total? (kwacha)",
         cl = "ADDED: Do they consistently use chlorine?",
         tank_cleaned = "ADDED: Is the tank ever cleaned?",
         tank_cleaned_cost = "ADDED: What additional monthly costs does the cleaning incur?",
         per_reg_pay = "What percent of users regularly pay the tariffs? (%)",
         per_wont_pay = "ADDED: What percent can pay but don't want to?",
         per_cant_pay = "ADDED: What percent can't pay?",
         comm_taps = "How many communal taps are there?",
         comm_tap_rate = "ADDED: Communal tap monthly rate",
         HH_taps = "How many private household taps are there?",
         HH_tap_rate = "ADDED: What is the monthly private household connection rate? (monthly kwacha)",
         PI_taps = "How many Public Institution taps are there? Ex) school or healthcare facility",
         PI_mo_rate = "ADDED: Public Institution monthly contribution",
         bank_account = "How much is currently in your bank account? (kwacha)",
         cash = "How much do you have in cash? (kwacha)",
         finance_own_repairs = "ADDED: Is the scheme able to finance its own repairs?",
         tanks_empty = "ADDED: Do the tanks ever go empty?",
         want_trainings = "ADDED: Did the scheme committee mention the need for better community engagement or more trainings?",
         minor_repair_mo_cost = "ADDED: average monthly minor repair costs",
         )

collumns_renamed = colnames(filtered_data_renamed)

view(collumns)
view(collumns_renamed)

```

```{r}

# I want to rename some of the schemes to be more visually appealing
filtered_data_renamed <- filtered_data_renamed %>%
  mutate(
    name = case_when(
      name == "Glasten scheme" ~ "Glasten (mega)",
      name == "Njuli water scheme" ~ "Njuli",
      name == "Kudziwa Scheme" ~ "Kudziwa",
      name == "Ndunde water scheme" ~ "Ndunde",
      name == "Malavi scheme" ~ "Malavi",
      name == "Chikopa scheme" ~ "Chikopa",
      name == "Muhasuwa water scheme" ~ "Muhasuwa",
      name == "Ndakwera community" ~ "Ndakwera",
      name == "Mwayi primary water scheme" ~ "Mwayi primary",
      name == "Mphatika Water system" ~ "Mphatika",
      name == "Tomali Primary School Scheme" ~ "Tomali Primary",
      name == "Mangulenje Water Scheme" ~ "Mangulenje",
      TRUE ~ name  # keep all other names unchanged
    )
  )

unique(filtered_data_renamed$name)
```

```{r}
# making some initial new variables

# First, changing the data into numerical for calculations
filtered_data_renamed <- filtered_data_renamed |> 
  mutate(across(
    c(HH, HH_monthly_income, water_volume, CapManEx_cost, guard_mo_cost, 
      per_reg_pay, per_wont_pay, per_cant_pay, comm_taps, comm_tap_rate, 
      HH_taps, HH_tap_rate, PI_mo_rate, bank_account, cash, minor_repair_mo_cost),
    as.numeric
  ))


## CAPMANEX ##
# Need to calculate the total months that have passed since completion
library(lubridate)
filtered_data_renamed <- filtered_data_renamed |> 
  mutate(
    mo_since_built = interval(ymd(date_finished), today()) %/% months(1)
  )

# Now I want to calculate the monthly CapManEx costs
filtered_data_renamed <- filtered_data_renamed |> 
  mutate(
    CapManEx_mo_cost = CapManEx_cost / mo_since_built
  )


## OPEX ##
# First we need to create a new column for chlorine costs because most of the data on chlorine use was deemed not useable
filtered_data_renamed <- filtered_data_renamed |> 
  mutate(
    cl_mo_cost = if_else(cl %in% c("yes", "Yes"), 12500, NA_real_)
  )

# Now I want to calc total monthly OpEx costs by adding the cost of the guards, minor repairs, and chlorine
filtered_data_renamed <- filtered_data_renamed |> 
  mutate(
    OpEx_mo_cost = rowSums(across(c(guard_mo_cost, minor_repair_mo_cost, cl_mo_cost)), na.rm = TRUE)
  )

## TOTAL COST ##
# Now I want to add CapManEx and OpEx to get the total monthly cost
filtered_data_renamed <- filtered_data_renamed %>%
  mutate(
    total_mo_cost = rowSums(across(c(CapManEx_mo_cost, OpEx_mo_cost)), na.rm = TRUE)
  )


##Tariff Collection
# Calc revenue collected by communal taps
filtered_data_renamed <- filtered_data_renamed |> 
  mutate(
    comm_mo_tariff = HH * per_reg_pay / 100 * comm_tap_rate
  )

# Calc revenue collected by household private taps
filtered_data_renamed <- filtered_data_renamed |> 
  mutate(
    HH_mo_tariff = HH_taps * HH_tap_rate
  )

# Add up communal, private household, and Public Institution incomes for total monthly income
filtered_data_renamed <- filtered_data_renamed |> 
  mutate(
    total_mo_tariff = rowSums(across(c(comm_mo_tariff, HH_mo_tariff, PI_mo_rate)), na.rm = TRUE)
  )

view(filtered_data_renamed)
```

Now we have the total monthly costs and monthly revenue collected by each scheme. We shall compare the two to visualize how the schemes are performing.

```{r}
# Reshape data to long format
plot_data <- filtered_data_renamed %>%
  select(name, total_mo_cost, total_mo_tariff) %>%
  pivot_longer(cols = c(total_mo_cost, total_mo_tariff),
               names_to = "type",
               values_to = "kwacha")

# Create the double bar graph
ggplot(plot_data, aes(x = name, y = kwacha, fill = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c(
    "total_mo_cost" = "red",
    "total_mo_tariff" = "green"
  )) +
  labs(x = "Scheme", y = "Kwacha", fill = "Type") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

I now want to produce the same graph but divided by district

```{r}
# Divide the data by district and save into my processed data folder
Chikwawa <- filtered_data_renamed |>  filter(District == "Chikwawa")
Chiradzulu <- filtered_data_renamed |>  filter(District == "Chiradzulu")

# Save the dataframes as CSV files
readr::write_csv(Chikwawa, here::here("data", "processed", "Chikwawa.csv"))
readr::write_csv(Chiradzulu, here::here("data", "processed", "Chiradzulu.csv"))
readr::write_csv(filtered_data_renamed, here::here("data", "processed", "filtered_data_renamed.csv"))

```

```{r}
## Chikwawa ##
# Reshape data to long format
plot_data_Chikwawa <- Chikwawa |> 
  select(name, total_mo_cost, total_mo_tariff) |> 
  pivot_longer(cols = c(total_mo_cost, total_mo_tariff),
               names_to = "type",
               values_to = "kwacha")

# Create the double bar graph
ggplot(plot_data_Chikwawa, aes(x = name, y = kwacha, fill = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c(
    "total_mo_cost" = "red",
    "total_mo_tariff" = "green"
  )) +
  labs(x = "Scheme", y = "Kwacha", fill = "Type", title = "Chikwawa") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

## Chiradzulu ##
# Reshape data to long format
plot_data_Chiradzulu <- Chiradzulu |> 
  select(name, total_mo_cost, total_mo_tariff) |> 
  pivot_longer(cols = c(total_mo_cost, total_mo_tariff),
               names_to = "type",
               values_to = "kwacha")

# Create the double bar graph
ggplot(plot_data_Chiradzulu, aes(x = name, y = kwacha, fill = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c(
    "total_mo_cost" = "red",
    "total_mo_tariff" = "green"
  )) +
  labs(x = "Scheme", y = "Kwacha", fill = "Type", title = "Chiradzulu") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

I have now made a new object including only the data i want to be working with. I split the data based on the scheme's district and make a new object for each.

\[This will be the core of your analysis with specific requirements\]

# Conclusions

## Summary of Findings

## Questions and Next Steps
