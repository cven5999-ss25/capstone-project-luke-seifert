---
title: "First doc creation - data analysis"
author:
  - name: "Luke Seifert"
    orcid: "0009-0007-4689-8492"
    email: "luse8755@colorado.edu"
    affiliation:
      - name: "University of Colorado Boulder"
        department: "Department of Civil, Environmental and Architectural Engineering"
        city: "Boulder"
        state: "CO"
        country: "USA"
date: today
format: html
editor: visual
---

# Introduction

I am in Blantyre, Malawi, working with Water For People (WFP) - Malawi to collect data on their rural piped water schemes. WFP has built many piped water schemes for rural communities, either from scratch or by upgrading an existing handpump borehole. Once the scheme is handed over to the community, the community is responsible for keeping the system running, encouraging ownership and sustainability, yet some schemes have been struggling to finance their own repairs.

I have been surveying these rural water scheme commities, collecting data on the costs they incur for keeping their water systems running and the monthly revenue they collect via tariffs. By comparing the costs and revenue generated by the schemes, we aim to try and identify the best practices in the rural water sector. The goal is to determine the gaps between costs and revenue, identify any trends between revenue collection and scheme success, and provide stakeholders with the results to encourage data-based decision making. Identifying these trends will help law makers and scheme committies to implement best practices to encourage sustainability of these rural schemes.

My data set will have quantitative data regarding costs of CapEx, CapManEx, and OpEx, quantitative data regarding revenue generated, qualitative data regarding tariff collection methods, and qualitative data regarding scheme sustainability and productivity.

# Methods

## Reading the Data

```{r}

# Load packages
library(tidyverse)
library(dplyr)
library(readr)
library(ggplot2)

# Read data
raw_data <- read_csv(here::here("data/raw/WFP_data_cleaned_with_joseph_7_9.csv"))
```

## Data Exploration Approach

The survey used for data collection was designed by myself in partnership with WFP. Due to resource allocation and a language barrier between myself and the rural communities, we relied on local workers employed by the government to collect the majority of this data. These workers are called "Water Monitoring Assistants", or "WMAs", and they oversee water access infrastructure in these rural areas.

We hosted a training session with the WMAs to show them how to properly deliver this survey to the water scheme committees. Fuel was then provided for the WMAs and they were sent out to their respective areas.

Being several degrees removed from the data we are collecting, the survey responses needed some cleaning up before being able to be analyzed.

## Initial Data Tidying

Before the data set was able to be uploaded into posit.cloud, initial data tidying consisted heavily of fixing obvious data entry errors, addressing inconsistencies or questions left blank, and creating useful data out of response discrepancies.

Some questions were often skipped over and answered partially. Some data recieved was contradictory and needed clarification. Other data was difficult to decipher due to our language barrier. Surveys with these issues were rejected and sent back to the corresponding WMA for re-submission.

The resulting tidied data set has been uploaded to the data/raw folder, and is ready for further data tidying and analysis.

# Results

## Initial Data Exploration

```{r}

#adding data to view first few rows of raw data

#head(raw_data)
dim(raw_data)
#spec(raw_data)
#colnames(raw_data)
```

```{r}
# Select only the desired columns
filtered_data <- raw_data |> 
  select(
    # General Info
    "What is your full name?",
    "District",
    "What is the name of the scheme you are currently visiting?",

    # Misc
    "How many total households does this scheme service? (HH)",
    "When was the scheme finished being built?...3",
    "How much total water can they hold? (liters)",
    "What is the average household monthly income in this village? (kwacha)",

    # CapManEx
    "ADDED: Total CapManEx costs (Kwacha)",

    # OpEx
    "ADDED: Are guards stationed at the scheme by the scheme committee?",
    "ADDED: If yes, how much are they paid in total? (kwacha)",
    "ADDED: Do they consistently use chlorine?",
    "ADDED: average monthly minor repair costs",
    "ADDED: Is the tank ever cleaned?",
    "ADDED: What additional monthly costs does the cleaning incur?",

    # Tariff Revenue
    "What percent of users regularly pay the tariffs? (%)",
    "ADDED: What percent can pay but don't want to?",
    "ADDED: What percent can't pay?",
    "How are tariffs collected?",
    "How many communal taps are there?",
    "ADDED: Communal tap monthly rate",
    "How many private household taps are there?",
    "ADDED: What is the monthly private household connection rate? (monthly kwacha)",
    "How many Public Institution taps are there? Ex) school or healthcare facility",
    "Do the public institutions pay a fee? If so, how much?",
    "How much is currently in your bank account? (kwacha)",
    "How much do you have in cash? (kwacha)",

    # Concluding Questions
    "ADDED: Is the scheme able to finance its own repairs?",
    "ADDED: Do the tanks ever go empty?",
    "ADDED: Did the scheme committee mention the need for better community engagement or more trainings?"
  )

# Delete empty rows
filtered_data <- filtered_data[-c(25:35), ]

# View the filtered data
view(filtered_data)
colnames(filtered_data)

```

```{r}

collumns <- colnames(filtered_data)

# Rename columns for easier coding
filtered_data_renamed <- filtered_data |> 
  rename(name = "What is the name of the scheme you are currently visiting?",
         HH = "How many total households does this scheme service? (HH)",
         HH_monthly_income = "What is the average household monthly income in this village? (kwacha)",
         CapManEx_cost = "ADDED: Total CapManEx costs (Kwacha)",
         guard = "ADDED: Are guards stationed at the scheme by the scheme committee?", 
         guard_cost = "ADDED: If yes, how much are they paid in total? (kwacha)",
         cl = "ADDED: Do they consistently use chlorine?",
         tank_cleaned = "ADDED: Is the tank ever cleaned?",
         tank_cleaned_cost = "ADDED: What additional monthly costs does the cleaning incur?",
         per_reg_pay = "What percent of users regularly pay the tariffs? (%)",
         per_wont_pay = "ADDED: What percent can pay but don't want to?",
         per_cant_pay = "ADDED: What percent can't pay?",
         comm_taps = "How many communal taps are there?",
         comm_tap_rate = "ADDED: Communal tap monthly rate",
         HH_taps = "How many private household taps are there?",
         HH_par_rate = "ADDED: What is the monthly private household connection rate? (monthly kwacha)",
         PI_taps = "How many Public Institution taps are there? Ex) school or healthcare facility",
         bank_account = "How much is currently in your bank account? (kwacha)",
         cash = "How much do you have in cash? (kwacha)",
         finance_own_repairs = "ADDED: Is the scheme able to finance its own repairs?",
         tanks_empty = "ADDED: Do the tanks ever go empty?",
         want_trainings = "ADDED: Did the scheme committee mention the need for better community engagement or more trainings?",
         OpEx_cost = "ADDED: average monthly minor repair costs",
         )

collumns_renamed = colnames(filtered_data_renamed)


```

```{r}
# making some initial new variables

# First, changing the data into numerical for calculations
filtered_data_renamed <- filtered_data_renamed |> 
  mutate(across(
    c(CapManEx_cost, guard_cost, tank_cleaned_cost),
    ~ as.numeric(.)
  ))


# calculate total monthly income for each scheme

##### having troubles here

filtered_data_renamed <- filtered_data_renamed %>%
  mutate(
    total_monthly_cost = rowSums(
      select(., CapManEx_cost, guard_cost, tank_cleaned_cost),
      na.rm = TRUE
    )
  )

#### need to figure out why so many nas
```

```{r}
Chikwawa <- filtered_data_renamed |>  filter(District == "Chikwawa")
Chiradzulu <- filtered_data_renamed |>  filter(District == "Chiradzulu")

# Save the dataframes as CSV files
readr::write_csv(Chikwawa, here::here("data", "processed", "Chikwawa.csv"))
readr::write_csv(Chiradzulu, here::here("data", "processed", "Chiradzulu.csv"))
readr::write_csv(filtered_data_renamed, here::here("data", "processed", "filtered_data_renamed.csv"))

view(collumns)
view(collumns_renamed)
```

I have now made a new object including only the data i want to be working with. I split the data based on the scheme's district and make a new object for each.

\[This will be the core of your analysis with specific requirements\]

# Conclusions

## Summary of Findings

## Questions and Next Steps
